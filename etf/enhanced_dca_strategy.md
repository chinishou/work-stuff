# 動態條件式 DCA 策略總覽

## 策略目標

在維持與傳統定期定額相近風險的前提下，透過條件觸發買入與動態參數調整，追求更高報酬率。

基準：0050 定期定額年化報酬約 14%

---

## 一、什麼時候買？（觸發條件）

### 三個信號，加權判斷

| 信號 | 說明 | 觸發條件 |
|------|------|----------|
| 信號 1：跌破均線 | 價格低於移動平均線一定幅度 | 價格 < MA(N) × (1 - 閾值%) |
| 信號 2：從高點回落 | 價格從近期高點下跌一定幅度 | 價格 < 近M日高點 × (1 - 閾值%) |
| 信號 3：KDJ 超賣 | KDJ 指標顯示超賣 | K < 超賣線 且 K 上穿 D，或 J < 10 |

```
買入條件：w1×信號1 + w2×信號2 + w3×信號3 ≥ 觸發門檻
```

### 參數範圍

| 參數 | 說明 | 測試範圍 |
|------|------|----------|
| 均線天數 N | 移動平均的計算天數 | 5, 10, 20, 60 |
| 均線閾值 | 要跌破均線多少 | 1%, 2%, 3%, 5% |
| 高點回溯天數 M | 「近期高點」的觀察天數 | 5, 10, 20 |
| 回落閾值 | 從高點跌多少算觸發 | 3%, 5%, 7%, 10% |
| K 超賣線 | K 值低於多少算超賣 | 20, 30 |
| J 極值線 | J 值低於多少算極端超賣 | 0, 10 |
| 信號權重 w1:w2:w3 | 三個信號的相對重要性 | 各種組合，總和=1 |
| 觸發門檻 | 加權分數要多高才買 | 0.3, 0.5, 0.7 |

---

## 二、每次買多少？（金額計算）

### 波動率調整邏輯

波動大時少買一點（分散風險），波動小時多買一點（把握機會）。

```
標準化波動率 = ATR(N) ÷ 收盤價 × 100

買入金額 = 基本金額 × (歷史平均波動率 ÷ 當前波動率)

限制：金額 clamp 在 [下限倍數 × 基本, 上限倍數 × 基本]
```

### 參數範圍

| 參數 | 說明 | 測試範圍 |
|------|------|----------|
| ATR 天數 | 計算 ATR 的週期 | 7, 14, 20 |
| 波動率基準期 | 「歷史平均」看多久 | 20, 60, 120 天 |
| 金額上限倍數 | 單次最多買幾倍 | 1.5, 2.0 |
| 金額下限倍數 | 單次最少買幾倍 | 0.5, 0.7 |

---

## 三、一個月買幾次？（次數控制）

### 月度次數範圍

設定每月買入次數的上下限，避免買太少（錯過機會）或太多（手續費）。

### 月底處理模式

| 模式 | 說明 |
|------|------|
| 模式 A | 強制補買：月底不管價格，補買到最低次數 |
| 模式 BC | 滾動累積：不硬買，剩餘額度按比例增加下月單筆金額 |

```
模式 BC 公式：
下月金額乘數 = 1 + (未用次數 ÷ 預期次數) × 滾動比例
```

### 參數範圍

| 參數 | 說明 | 測試範圍 |
|------|------|----------|
| 最少次數 | 每月至少買幾次 | 2, 3, 4 |
| 最多次數 | 每月最多買幾次 | 5, 6, 7, 8 |
| 月底模式 | 買不夠怎麼處理 | A, BC |
| 滾動比例 | BC 模式下滾動多少到下月 | 50%, 75%, 100% |

---

## 四、冷卻機制

### 避免短時間內連續觸發

買入後需要同時滿足兩個條件才能再次買入：

```
條件 1：距離上次買入 ≥ 冷卻天數
條件 2：價格較上次買入價再跌 ≥ 冷卻跌幅
```

### 參數範圍

| 參數 | 說明 | 測試範圍 |
|------|------|----------|
| 冷卻天數 | 買完要等幾天 | 0, 1, 2, 3 |
| 冷卻跌幅 | 要再跌多少才能買 | 0%, 1%, 2% |

---

## 五、參數選擇層（每月調整）

### 多時間框架加權評估

```
在時間點 T 選參數：

對每組參數 P：
  score(P) = w1 × 過去1年表現
           + w2 × 過去6個月表現
           + w3 × 過去3個月表現
           + w4 × 過去1個月表現

選 score 最高的 P
```

### Meta 參數

| 參數 | 說明 | 選項 |
|------|------|------|
| 時間權重 | 長期 vs 短期的重要性 | [4:3:2:1], [5:3:2:0], [3:3:3:1], [6:3:1:0] |
| 評估指標 | 用什麼衡量「表現好」 | 報酬率, 夏普比率, Calmar比率, 綜合分數 |
| 選擇方式 | 怎麼從結果中選 | Top1, Top3平均, Top5平均 |
| 參數平滑 | 是否與上期混合 | 無, 與上期各半 |

### 績效指標定義

```
報酬率 = (期末淨值 ÷ 期初淨值) - 1
夏普比率 = (年化報酬 - 無風險利率) ÷ 年化波動率
Calmar比率 = 年化報酬 ÷ 最大回撤
綜合分數 = 0.4×報酬率 + 0.3×夏普 + 0.3×(1-最大回撤)
```

---

## 六、方法驗證層（一層遞歸）

### 同時驗證方法並產出參數

```
在時間點 T，決定用什麼「選參數方法」：

對每種方法 M：
  模擬過去 12 個月的 walk-forward：
    for t in [T-12, T-11, ..., T-1]:
      用方法 M 在 t 選參數（靜態回測，不再遞歸）
      用選出的參數執行 t 月交易
      記錄績效
  
  方法 M 的驗證績效 = 12 個月模擬總績效
  方法 M 的輸出參數 = 最後一期（T-1月）選出的參數

選驗證績效最好的方法 → 使用其輸出參數執行本月交易
```

---

## 七、系統架構

```
┌─────────────────────────────────────────────────────────────┐
│  每月執行流程                                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 方法驗證層                                               │
│     ┌─────────────────────────────────────────────────┐     │
│     │ 對每種「選參數方法」M：                           │     │
│     │   模擬過去12個月 walk-forward                    │     │
│     │   ├─────────────────────────────────────────┐   │     │
│     │   │ 2. 參數選擇層（模擬中每月執行）          │   │     │
│     │   │    對每組參數 P：多時間框架加權評估       │   │     │
│     │   │    ├─────────────────────────────────┐  │   │     │
│     │   │    │ 3. 靜態回測                     │  │   │     │
│     │   │    │    用固定參數模擬交易            │  │   │     │
│     │   │    │    回傳績效指標                  │  │   │     │
│     │   │    └─────────────────────────────────┘  │   │     │
│     │   └─────────────────────────────────────────┘   │     │
│     │                                                │     │
│     │ → 選出最佳方法 M* 及其輸出參數 P*               │     │
│     └─────────────────────────────────────────────────┘     │
│                            │                                │
│                            ▼                                │
│  4. 交易執行層                                               │
│     用參數 P* 執行本月交易                                   │
│     - 每日檢查觸發條件                                       │
│     - 波動率調整買入金額                                     │
│     - 冷卻機制控制                                           │
│     - 月底處理                                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 八、參數搜索策略

### 三階段搜索法

由於參數組合數量龐大（百萬級），採用分階段搜索：

#### 階段 1：粗篩（Random Search）

```
目的：快速找出有潛力的區域
做法：隨機抽 2000-5000 組參數，快速回測
產出：表現前 10% 的參數特徵
時間：約 5-10 分鐘
```

#### 階段 2：區域聚焦

```
目的：縮小搜索範圍
做法：分析 Top 10% 參數的共同特徵
產出：縮小後的參數範圍（約 1-5 萬組）
```

#### 階段 3：細搜

```
目的：在縮小範圍內精確搜索
做法：
  - Grid Search：細步長遍歷
  - Bayesian Optimization：機率模型引導搜索
  - 或兩者結合
時間：約 30-60 分鐘
```

#### 驗證：鄰近參數檢查

```
確保最佳參數的「鄰居」表現也不錯
避免選到孤立的過擬合峰值
```

### 搜索流程圖

```
隨機抽樣 2000-5000 組
        │
        ▼
  快速回測，找 Top 10%
        │
        ▼
分析共同特徵，縮小範圍
        │
        ▼
   細搜（Grid / Bayesian）
        │
        ▼
   鄰近參數驗證
        │
        ▼
     最終參數
```

---

## 九、基準比較

| 比較對象 | 說明 |
|----------|------|
| 定期定額 | 每月固定日期買入固定金額 |
| 固定參數策略 | 用固定參數不調整，評估動態調整的附加價值 |

---

## 十、測試標的

| 標的 | 市場 | 說明 |
|------|------|------|
| QQQ | 美股 | 追蹤 Nasdaq-100，科技股為主 |
| VOO | 美股 | 追蹤 S&P 500，大盤代表 |
| 006208 | 台股 | 富邦台50，追蹤台灣50指數 |

---

## 十一、數據需求

### 必要欄位

- 日期（Date）
- 開盤價（Open）
- 最高價（High）
- 最低價（Low）
- 收盤價（Close）
- 成交量（Volume）

### 衍生指標（程式計算）

- MA(N)：N 日移動平均
- ATR(N)：N 日平均真實範圍
- KDJ：K、D、J 值

### 數據長度需求

- 最少：3 年（1 年訓練 + 1 年驗證 + 1 年測試）
- 建議：5-10 年（涵蓋多種市況）

---

## 附錄：技術指標計算公式

### ATR（Average True Range）

```
True Range = max(
    當日高 - 當日低,
    |當日高 - 昨收|,
    |當日低 - 昨收|
)

ATR(N) = True Range 的 N 日移動平均
```

### KDJ

```
RSV = (收盤價 - N日最低) ÷ (N日最高 - N日最低) × 100

K = 前日K × (1 - 1/M1) + RSV × (1/M1)
D = 前日D × (1 - 1/M2) + K × (1/M2)
J = 3K - 2D

常用參數：N=9, M1=3, M2=3
```
